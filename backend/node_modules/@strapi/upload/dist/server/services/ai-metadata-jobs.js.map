{"version":3,"file":"ai-metadata-jobs.js","sources":["../../../server/src/services/ai-metadata-jobs.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\n\nimport { AIMetadataJob } from '../../../shared/contracts/ai-metadata-jobs';\nimport { AI_METADATA_JOB_UID } from '../models/ai-metadata-job';\n\nexport const createAIMetadataJobsService = ({ strapi }: { strapi: Core.Strapi }) => ({\n  async createJob(): Promise<number> {\n    const job = await strapi.db.query(AI_METADATA_JOB_UID).create({\n      data: {\n        status: 'processing',\n        createdAt: new Date(),\n      },\n    });\n\n    return job.id;\n  },\n\n  async getJob(jobId: number): Promise<AIMetadataJob | null> {\n    return strapi.db.query(AI_METADATA_JOB_UID).findOne({\n      where: { id: jobId },\n    });\n  },\n\n  async updateJob(\n    jobId: number,\n    updates: Partial<Omit<AIMetadataJob, 'id' | 'createdAt'>>\n  ): Promise<void> {\n    await strapi.db.query(AI_METADATA_JOB_UID).update({\n      where: { id: jobId },\n      data: updates,\n    });\n  },\n\n  async deleteJob(jobId: number): Promise<void> {\n    await strapi.db.query(AI_METADATA_JOB_UID).delete({\n      where: { id: jobId },\n    });\n  },\n\n  async getLatestActiveJob(): Promise<AIMetadataJob | null> {\n    // Return the most recent job, regardless of status\n    // This allows the frontend to see completed/failed status\n    return strapi.db.query(AI_METADATA_JOB_UID).findOne({\n      orderBy: { createdAt: 'desc' },\n    });\n  },\n\n  async registerCron() {\n    strapi.cron.add({\n      aiMetadataJobsCleanup: {\n        async task() {\n          try {\n            const result = await strapi.db.query(AI_METADATA_JOB_UID).deleteMany({\n              where: {\n                status: { $ne: 'processing' },\n              },\n            });\n\n            if (result.count > 0) {\n              strapi.log.info(`Cleaned up ${result.count} old AI metadata jobs`);\n            }\n          } catch (error) {\n            strapi.log.error('Failed to cleanup AI metadata jobs:', error);\n          }\n        },\n        options: '0 0 * * *', // Run once a day at midnight\n      },\n    });\n  },\n});\n\nexport type { AIMetadataJob };\n"],"names":["createAIMetadataJobsService","strapi","createJob","job","db","query","AI_METADATA_JOB_UID","create","data","status","createdAt","Date","id","getJob","jobId","findOne","where","updateJob","updates","update","deleteJob","delete","getLatestActiveJob","orderBy","registerCron","cron","add","aiMetadataJobsCleanup","task","result","deleteMany","$ne","count","log","info","error","options"],"mappings":";;;;MAKaA,2BAA8B,GAAA,CAAC,EAAEC,MAAM,EAA2B,IAAM;QACnF,MAAMC,SAAAA,CAAAA,GAAAA;YACJ,MAAMC,GAAAA,GAAM,MAAMF,MAAOG,CAAAA,EAAE,CAACC,KAAK,CAACC,iCAAqBC,CAAAA,CAAAA,MAAM,CAAC;gBAC5DC,IAAM,EAAA;oBACJC,MAAQ,EAAA,YAAA;AACRC,oBAAAA,SAAAA,EAAW,IAAIC,IAAAA;AACjB;AACF,aAAA,CAAA;AAEA,YAAA,OAAOR,IAAIS,EAAE;AACf,SAAA;AAEA,QAAA,MAAMC,QAAOC,KAAa,EAAA;AACxB,YAAA,OAAOb,OAAOG,EAAE,CAACC,KAAK,CAACC,iCAAAA,CAAAA,CAAqBS,OAAO,CAAC;gBAClDC,KAAO,EAAA;oBAAEJ,EAAIE,EAAAA;AAAM;AACrB,aAAA,CAAA;AACF,SAAA;QAEA,MAAMG,SAAAA,CAAAA,CACJH,KAAa,EACbI,OAAyD,EAAA;AAEzD,YAAA,MAAMjB,OAAOG,EAAE,CAACC,KAAK,CAACC,iCAAAA,CAAAA,CAAqBa,MAAM,CAAC;gBAChDH,KAAO,EAAA;oBAAEJ,EAAIE,EAAAA;AAAM,iBAAA;gBACnBN,IAAMU,EAAAA;AACR,aAAA,CAAA;AACF,SAAA;AAEA,QAAA,MAAME,WAAUN,KAAa,EAAA;AAC3B,YAAA,MAAMb,OAAOG,EAAE,CAACC,KAAK,CAACC,iCAAAA,CAAAA,CAAqBe,MAAM,CAAC;gBAChDL,KAAO,EAAA;oBAAEJ,EAAIE,EAAAA;AAAM;AACrB,aAAA,CAAA;AACF,SAAA;QAEA,MAAMQ,kBAAAA,CAAAA,GAAAA;;;AAGJ,YAAA,OAAOrB,OAAOG,EAAE,CAACC,KAAK,CAACC,iCAAAA,CAAAA,CAAqBS,OAAO,CAAC;gBAClDQ,OAAS,EAAA;oBAAEb,SAAW,EAAA;AAAO;AAC/B,aAAA,CAAA;AACF,SAAA;QAEA,MAAMc,YAAAA,CAAAA,GAAAA;YACJvB,MAAOwB,CAAAA,IAAI,CAACC,GAAG,CAAC;gBACdC,qBAAuB,EAAA;oBACrB,MAAMC,IAAAA,CAAAA,GAAAA;wBACJ,IAAI;4BACF,MAAMC,MAAAA,GAAS,MAAM5B,MAAOG,CAAAA,EAAE,CAACC,KAAK,CAACC,iCAAqBwB,CAAAA,CAAAA,UAAU,CAAC;gCACnEd,KAAO,EAAA;oCACLP,MAAQ,EAAA;wCAAEsB,GAAK,EAAA;AAAa;AAC9B;AACF,6BAAA,CAAA;4BAEA,IAAIF,MAAAA,CAAOG,KAAK,GAAG,CAAG,EAAA;gCACpB/B,MAAOgC,CAAAA,GAAG,CAACC,IAAI,CAAC,CAAC,WAAW,EAAEL,MAAOG,CAAAA,KAAK,CAAC,qBAAqB,CAAC,CAAA;AACnE;AACF,yBAAA,CAAE,OAAOG,KAAO,EAAA;AACdlC,4BAAAA,MAAAA,CAAOgC,GAAG,CAACE,KAAK,CAAC,qCAAuCA,EAAAA,KAAAA,CAAAA;AAC1D;AACF,qBAAA;oBACAC,OAAS,EAAA;AACX;AACF,aAAA,CAAA;AACF;AACF,KAAA;;;;"}