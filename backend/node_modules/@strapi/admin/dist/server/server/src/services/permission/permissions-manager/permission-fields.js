'use strict';

var ability = require('@casl/ability');
var extra = require('@casl/ability/extra');
var fp = require('lodash/fp');

/**
 * Creates a cached permission fields calculator for a given CASL ability.
 *
 * The cache stores permission field calculations per action+subjectType combination.
 * Results are only cached when rules have no entity-specific conditions, as those
 * must be computed per entity.
 *
 * @param ability - The CASL ability instance to use for permission checks
 * @returns Object with getPermissionFields function and cache
 */ const createPermissionFieldsCache = (ability$1)=>{
    const permissionCache = new Map();
    const getPermissionFields = (actionOverride, subject)=>{
        const subjectType = ability.detectSubjectType(subject);
        const rules = ability$1.rulesFor(actionOverride, subjectType);
        // Check if any rule has conditions that depend on entity data
        // If so, we can't cache - must compute per entity
        const hasEntityConditions = rules.some((rule)=>rule.conditions && !fp.isEmpty(rule.conditions));
        // Return cached result if available and safe to use
        const cacheKey = `${actionOverride}::${String(subjectType)}`;
        if (!hasEntityConditions && permissionCache.has(cacheKey)) {
            return permissionCache.get(cacheKey);
        }
        // Compute permission fields (expensive CASL operation)
        const permittedFields = extra.permittedFieldsOf(ability$1, actionOverride, subject, {
            fieldsFrom: (rule)=>rule.fields || []
        });
        const hasAtLeastOneRegistered = fp.some((fields)=>!fp.isNil(fields), fp.flatMap(fp.prop('fields'), rules));
        const shouldIncludeAll = fp.isEmpty(permittedFields) && !hasAtLeastOneRegistered;
        const result = {
            permittedFields,
            hasAtLeastOneRegistered,
            shouldIncludeAll
        };
        // Cache for reuse if no entity-specific conditions
        if (!hasEntityConditions) {
            permissionCache.set(cacheKey, result);
        }
        return result;
    };
    return {
        getPermissionFields,
        clearCache: ()=>permissionCache.clear()
    };
};

exports.createPermissionFieldsCache = createPermissionFieldsCache;
//# sourceMappingURL=permission-fields.js.map
