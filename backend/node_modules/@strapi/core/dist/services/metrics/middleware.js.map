{"version":3,"file":"middleware.js","sources":["../../../src/services/metrics/middleware.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport type { Sender } from './sender';\n\ninterface State {\n  expires: number;\n  counter: number;\n}\n\nfunction nextResetDate(): number {\n  return Date.now() + 24 * 60 * 60 * 1000; // Now + 24 hours.\n}\n\nconst createMiddleware = ({ sendEvent, strapi }: { sendEvent: Sender; strapi: Core.Strapi }) => {\n  const state: State = {\n    expires: nextResetDate(),\n    counter: 0,\n  };\n\n  const middleware: Core.MiddlewareHandler = async (ctx, next) => {\n    const { url, method } = ctx.request;\n\n    // Only track API requests (skip static assets)\n    const shouldTrack =\n      !url.includes('.') &&\n      url.includes(strapi.config.get('api.rest.prefix')) &&\n      ['GET', 'PUT', 'POST', 'DELETE'].includes(method);\n\n    if (shouldTrack) {\n      // Reset counter if expired\n      if (Date.now() > state.expires) {\n        state.expires = nextResetDate();\n        state.counter = 0;\n      }\n\n      // Track on response finish if under limit\n      // Increment counter immediately to prevent race conditions\n      if (state.counter < 1000) {\n        state.counter += 1;\n\n        let tracked = false;\n        const trackOnFinish = () => {\n          if (tracked) return;\n          tracked = true;\n\n          const statusCode = typeof ctx.response?.status === 'number' ? ctx.response.status : 500;\n          const success = statusCode >= 200 && statusCode < 300;\n\n          // Silently handle tracking errors - telemetry failures shouldn't affect the app\n          Promise.resolve(\n            sendEvent('didReceiveRequest', {\n              eventProperties: {\n                url: ctx.request.url,\n                success,\n                statusCode,\n              },\n            })\n          ).catch(() => {\n            // Ignore tracking errors\n          });\n        };\n\n        // Track when response finishes (success or error)\n        ctx.res.once('finish', trackOnFinish);\n        ctx.res.once('close', trackOnFinish);\n      }\n    }\n\n    await next();\n  };\n\n  return middleware;\n};\n\nexport default createMiddleware;\n"],"names":["nextResetDate","Date","now","createMiddleware","sendEvent","strapi","state","expires","counter","middleware","ctx","next","url","method","request","shouldTrack","includes","config","get","tracked","trackOnFinish","statusCode","response","status","success","Promise","resolve","eventProperties","catch","res","once"],"mappings":";;AAQA,SAASA,aAAAA,GAAAA;AACP,IAAA,OAAOC,KAAKC,GAAG,EAAA,GAAK,KAAK,EAAK,GAAA,EAAA,GAAK;AACrC;AAEA,MAAMC,mBAAmB,CAAC,EAAEC,SAAS,EAAEC,MAAM,EAA8C,GAAA;AACzF,IAAA,MAAMC,KAAe,GAAA;QACnBC,OAASP,EAAAA,aAAAA,EAAAA;QACTQ,OAAS,EAAA;AACX,KAAA;IAEA,MAAMC,UAAAA,GAAqC,OAAOC,GAAKC,EAAAA,IAAAA,GAAAA;AACrD,QAAA,MAAM,EAAEC,GAAG,EAAEC,MAAM,EAAE,GAAGH,IAAII,OAAO;;AAGnC,QAAA,MAAMC,WACJ,GAAA,CAACH,GAAII,CAAAA,QAAQ,CAAC,GACdJ,CAAAA,IAAAA,GAAAA,CAAII,QAAQ,CAACX,MAAOY,CAAAA,MAAM,CAACC,GAAG,CAAC,iBAC/B,CAAA,CAAA,IAAA;AAAC,YAAA,KAAA;AAAO,YAAA,KAAA;AAAO,YAAA,MAAA;AAAQ,YAAA;AAAS,SAAA,CAACF,QAAQ,CAACH,MAAAA,CAAAA;AAE5C,QAAA,IAAIE,WAAa,EAAA;;AAEf,YAAA,IAAId,IAAKC,CAAAA,GAAG,EAAKI,GAAAA,KAAAA,CAAMC,OAAO,EAAE;AAC9BD,gBAAAA,KAAAA,CAAMC,OAAO,GAAGP,aAAAA,EAAAA;AAChBM,gBAAAA,KAAAA,CAAME,OAAO,GAAG,CAAA;AAClB;;;YAIA,IAAIF,KAAAA,CAAME,OAAO,GAAG,IAAM,EAAA;AACxBF,gBAAAA,KAAAA,CAAME,OAAO,IAAI,CAAA;AAEjB,gBAAA,IAAIW,OAAU,GAAA,KAAA;AACd,gBAAA,MAAMC,aAAgB,GAAA,IAAA;AACpB,oBAAA,IAAID,OAAS,EAAA;oBACbA,OAAU,GAAA,IAAA;oBAEV,MAAME,UAAAA,GAAa,OAAOX,GAAAA,CAAIY,QAAQ,EAAEC,MAAW,KAAA,QAAA,GAAWb,GAAIY,CAAAA,QAAQ,CAACC,MAAM,GAAG,GAAA;oBACpF,MAAMC,OAAAA,GAAUH,UAAc,IAAA,GAAA,IAAOA,UAAa,GAAA,GAAA;;oBAGlDI,OAAQC,CAAAA,OAAO,CACbtB,SAAAA,CAAU,mBAAqB,EAAA;wBAC7BuB,eAAiB,EAAA;4BACff,GAAKF,EAAAA,GAAAA,CAAII,OAAO,CAACF,GAAG;AACpBY,4BAAAA,OAAAA;AACAH,4BAAAA;AACF;AACF,qBAAA,CAAA,CAAA,CACAO,KAAK,CAAC,IAAA;;AAER,qBAAA,CAAA;AACF,iBAAA;;AAGAlB,gBAAAA,GAAAA,CAAImB,GAAG,CAACC,IAAI,CAAC,QAAUV,EAAAA,aAAAA,CAAAA;AACvBV,gBAAAA,GAAAA,CAAImB,GAAG,CAACC,IAAI,CAAC,OAASV,EAAAA,aAAAA,CAAAA;AACxB;AACF;QAEA,MAAMT,IAAAA,EAAAA;AACR,KAAA;IAEA,OAAOF,UAAAA;AACT;;;;"}