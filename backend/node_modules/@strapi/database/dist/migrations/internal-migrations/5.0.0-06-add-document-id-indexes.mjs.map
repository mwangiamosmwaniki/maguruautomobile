{"version":3,"file":"5.0.0-06-add-document-id-indexes.mjs","sources":["../../../src/migrations/internal-migrations/5.0.0-06-add-document-id-indexes.ts"],"sourcesContent":["import type { Knex } from 'knex';\n\nimport type { Migration } from '../common';\n\n// Add an index if it does not already exist\nconst createIndex = async (knex: Knex, tableName: string, columns: string[], indexName: string) => {\n  try {\n    // If the database can check for indexes, avoid duplicates\n    const hasIndex = (\n      knex.schema as unknown as {\n        hasIndex?: (tableName: string, indexName: string) => Promise<boolean>;\n      }\n    ).hasIndex;\n    if (hasIndex) {\n      const exists = await hasIndex.call(knex.schema, tableName, indexName);\n      if (exists) {\n        return;\n      }\n    }\n\n    await knex.schema.alterTable(tableName, (table) => {\n      table.index(columns, indexName);\n    });\n  } catch (error) {\n    // If the index exists (or cannot be created), move on\n  }\n};\n\nconst addIndexesForTable = async (knex: Knex, tableName: string) => {\n  // Only add indexes when the column is present\n  const hasDocumentId = await knex.schema.hasColumn(tableName, 'document_id');\n  if (!hasDocumentId) {\n    return;\n  }\n\n  const hasLocale = await knex.schema.hasColumn(tableName, 'locale');\n  const hasPublishedAt = await knex.schema.hasColumn(tableName, 'published_at');\n\n  // Single column index for basic lookups\n  await createIndex(knex, tableName, ['document_id'], `${tableName}_document_id_idx`);\n\n  if (hasLocale && hasPublishedAt) {\n    // Composite index for common filters\n    await createIndex(\n      knex,\n      tableName,\n      ['document_id', 'locale', 'published_at'],\n      `${tableName}_document_id_locale_published_at_idx`\n    );\n  } else if (hasLocale) {\n    await createIndex(\n      knex,\n      tableName,\n      ['document_id', 'locale'],\n      `${tableName}_document_id_locale_idx`\n    );\n  } else if (hasPublishedAt) {\n    await createIndex(\n      knex,\n      tableName,\n      ['document_id', 'published_at'],\n      `${tableName}_document_id_published_at_idx`\n    );\n  }\n};\n\nexport const addDocumentIdIndexes: Migration = {\n  name: '5.0.0-06-add-document-id-indexes',\n  async up(knex, db) {\n    for (const meta of db.metadata.values()) {\n      const hasTable = await knex.schema.hasTable(meta.tableName);\n      if (!hasTable) {\n        continue;\n      }\n\n      await addIndexesForTable(knex, meta.tableName);\n    }\n  },\n  async down() {\n    throw new Error('not implemented');\n  },\n};\n"],"names":["createIndex","knex","tableName","columns","indexName","hasIndex","schema","exists","call","alterTable","table","index","error","addIndexesForTable","hasDocumentId","hasColumn","hasLocale","hasPublishedAt","addDocumentIdIndexes","name","up","db","meta","metadata","values","hasTable","down","Error"],"mappings":"AAIA;AACA,MAAMA,WAAc,GAAA,OAAOC,IAAYC,EAAAA,SAAAA,EAAmBC,OAAmBC,EAAAA,SAAAA,GAAAA;IAC3E,IAAI;;AAEF,QAAA,MAAMC,QAAW,GACfJ,IAAKK,CAAAA,MAAM,CAGXD,QAAQ;AACV,QAAA,IAAIA,QAAU,EAAA;YACZ,MAAME,MAAAA,GAAS,MAAMF,QAASG,CAAAA,IAAI,CAACP,IAAKK,CAAAA,MAAM,EAAEJ,SAAWE,EAAAA,SAAAA,CAAAA;AAC3D,YAAA,IAAIG,MAAQ,EAAA;AACV,gBAAA;AACF;AACF;AAEA,QAAA,MAAMN,KAAKK,MAAM,CAACG,UAAU,CAACP,WAAW,CAACQ,KAAAA,GAAAA;YACvCA,KAAMC,CAAAA,KAAK,CAACR,OAASC,EAAAA,SAAAA,CAAAA;AACvB,SAAA,CAAA;AACF,KAAA,CAAE,OAAOQ,KAAO,EAAA;;AAEhB;AACF,CAAA;AAEA,MAAMC,kBAAAA,GAAqB,OAAOZ,IAAYC,EAAAA,SAAAA,GAAAA;;AAE5C,IAAA,MAAMY,gBAAgB,MAAMb,IAAAA,CAAKK,MAAM,CAACS,SAAS,CAACb,SAAW,EAAA,aAAA,CAAA;AAC7D,IAAA,IAAI,CAACY,aAAe,EAAA;AAClB,QAAA;AACF;AAEA,IAAA,MAAME,YAAY,MAAMf,IAAAA,CAAKK,MAAM,CAACS,SAAS,CAACb,SAAW,EAAA,QAAA,CAAA;AACzD,IAAA,MAAMe,iBAAiB,MAAMhB,IAAAA,CAAKK,MAAM,CAACS,SAAS,CAACb,SAAW,EAAA,cAAA,CAAA;;IAG9D,MAAMF,WAAAA,CAAYC,MAAMC,SAAW,EAAA;AAAC,QAAA;KAAc,EAAE,CAAA,EAAGA,SAAU,CAAA,gBAAgB,CAAC,CAAA;AAElF,IAAA,IAAIc,aAAaC,cAAgB,EAAA;;QAE/B,MAAMjB,WAAAA,CACJC,MACAC,SACA,EAAA;AAAC,YAAA,aAAA;AAAe,YAAA,QAAA;AAAU,YAAA;SAAe,EACzC,CAAA,EAAGA,SAAU,CAAA,oCAAoC,CAAC,CAAA;AAEtD,KAAA,MAAO,IAAIc,SAAW,EAAA;QACpB,MAAMhB,WAAAA,CACJC,MACAC,SACA,EAAA;AAAC,YAAA,aAAA;AAAe,YAAA;SAAS,EACzB,CAAA,EAAGA,SAAU,CAAA,uBAAuB,CAAC,CAAA;AAEzC,KAAA,MAAO,IAAIe,cAAgB,EAAA;QACzB,MAAMjB,WAAAA,CACJC,MACAC,SACA,EAAA;AAAC,YAAA,aAAA;AAAe,YAAA;SAAe,EAC/B,CAAA,EAAGA,SAAU,CAAA,6BAA6B,CAAC,CAAA;AAE/C;AACF,CAAA;MAEagB,oBAAkC,GAAA;IAC7CC,IAAM,EAAA,kCAAA;IACN,MAAMC,EAAAA,CAAAA,CAAGnB,IAAI,EAAEoB,EAAE,EAAA;AACf,QAAA,KAAK,MAAMC,IAAQD,IAAAA,EAAAA,CAAGE,QAAQ,CAACC,MAAM,EAAI,CAAA;YACvC,MAAMC,QAAAA,GAAW,MAAMxB,IAAKK,CAAAA,MAAM,CAACmB,QAAQ,CAACH,KAAKpB,SAAS,CAAA;AAC1D,YAAA,IAAI,CAACuB,QAAU,EAAA;AACb,gBAAA;AACF;YAEA,MAAMZ,kBAAAA,CAAmBZ,IAAMqB,EAAAA,IAAAA,CAAKpB,SAAS,CAAA;AAC/C;AACF,KAAA;IACA,MAAMwB,IAAAA,CAAAA,GAAAA;AACJ,QAAA,MAAM,IAAIC,KAAM,CAAA,iBAAA,CAAA;AAClB;AACF;;;;"}